{% extends "core/base.html" %}

{% block title %}{{ poll.title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <div class="card shadow-sm">
            <div class="card-body">
                {% if poll_user %}
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                    <div class="flex-shrink-0">
                        <i class="bi bi-person-circle fs-3 text-primary"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-0 text-muted small text-uppercase">Участник</h6>
                        <h5 class="mb-0 fw-semibold">{{ poll_user.name }}</h5>
                    </div>
                </div>
                {% endif %}
                
                <h1 class="h4 mb-4">{{ poll.title }}</h1>
                
                {% if status == "WAITING" %}
                    <!-- Опрос ещё не начался -->
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        Опрос ещё не начался. Пожалуйста, подождите.
                    </div>
                {% elif status == "FINISHED" %}
                    <!-- Опрос завершён -->
                    <div class="alert alert-secondary" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        Опрос завершён.
                    </div>
                {% elif already_voted %}
                    <!-- Уже проголосовал -->
                    <div class="alert alert-success" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        Вы уже проголосовали. Спасибо за участие!
                    </div>
                {% elif status == "PENDING" %}
                    <!-- Форма для голосования -->
                    <form method="post" id="voteForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <ul class="mb-0">
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        
                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <strong>Ошибки в форме:</strong>
                                <ul class="mb-0 mt-2">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        
                        {% for question in questions %}
                            <div class="mb-4 question-block" data-question-id="{{ question.id }}" data-question-type="{{ question.type }}" data-question-min="{{ question.min }}" data-question-max="{{ question.max }}">
                                <h5 class="mb-3">{{ question.text }}</h5>
                                
                                {% if question.type == "question" %}
                                    <!-- Обычный вопрос - радиокнопки -->
                                    <div class="form-check-group">
                                        {% for choice in question.choices.all %}
                                            <div class="form-check mb-3">
                                                <input 
                                                    class="form-check-input" 
                                                    type="radio" 
                                                    name="question_{{ question.id }}" 
                                                    id="choice_{{ choice.id }}" 
                                                    value="{{ choice.id }}"
                                                    required
                                                >
                                                <label class="form-check-label" for="choice_{{ choice.id }}">
                                                    {{ choice.choice }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <!-- Вопрос с мультивыбором - чекбоксы -->
                                    <div class="form-check-group">
                                        {% for choice in question.choices.all %}
                                            <div class="form-check mb-3">
                                                <input 
                                                    class="form-check-input choice-checkbox" 
                                                    type="checkbox" 
                                                    name="question_{{ question.id }}" 
                                                    id="choice_{{ choice.id }}" 
                                                    value="{{ choice.id }}"
                                                    data-question-id="{{ question.id }}"
                                                >
                                                <label class="form-check-label" for="choice_{{ choice.id }}">
                                                    {{ choice.choice }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <small class="text-muted d-block mt-2">
                                        {% if question.min == 0 %}
                                            Выберите до {{ question.max }} вариант(ов) (можно не выбирать)
                                        {% else %}
                                            Выберите от {{ question.min }} до {{ question.max }} вариант(ов)
                                        {% endif %}
                                    </small>
                                    <div class="text-danger small mt-1 error-message" id="error_{{ question.id }}" style="display: none;"></div>
                                {% endif %}
                            </div>
                            
                            {% if not forloop.last %}
                                <hr>
                            {% endif %}
                        {% endfor %}
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Отправить голос</button>
                        </div>
                    </form>
                {% endif %}
                
                <!-- Результаты голосования (отображаются после завершения опроса) -->
                {% if status == "FINISHED" %}
                    {% include "core/poll_results.html" %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const form = document.getElementById('voteForm');
    if (!form) return;
    
    // Валидация для вопросов с мультивыбором
    const checkboxes = form.querySelectorAll('.choice-checkbox');
    const questionBlocks = form.querySelectorAll('.question-block[data-question-type="multiple"]');
    
    function validateQuestion(questionBlock) {
        const questionId = questionBlock.dataset.questionId;
        const min = parseInt(questionBlock.dataset.questionMin);
        const max = parseInt(questionBlock.dataset.questionMax);
        const checkboxesInQuestion = form.querySelectorAll(`input[type="checkbox"][data-question-id="${questionId}"]:checked`);
        const checkedCount = checkboxesInQuestion.length;
        const errorElement = document.getElementById(`error_${questionId}`);
        
        // Сброс предыдущих ошибок
        if (errorElement) {
            errorElement.style.display = 'none';
            errorElement.textContent = '';
        }
        
        // Проверка минимального количества (если min > 0)
        if (min > 0 && checkedCount < min) {
            if (errorElement) {
                errorElement.textContent = `Выберите минимум ${min} вариант(ов)`;
                errorElement.style.display = 'block';
            }
            return false;
        }
        
        // Проверка максимального количества
        if (checkedCount > max) {
            if (errorElement) {
                errorElement.textContent = `Выберите максимум ${max} вариант(ов)`;
                errorElement.style.display = 'block';
            }
            return false;
        }
        
        return true;
    }
    
    // Валидация при изменении чекбоксов
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const questionId = this.dataset.questionId;
            const questionBlock = form.querySelector(`.question-block[data-question-id="${questionId}"]`);
            if (questionBlock) {
                validateQuestion(questionBlock);
            }
        });
    });
    
    // Валидация при отправке формы
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        questionBlocks.forEach(questionBlock => {
            if (!validateQuestion(questionBlock)) {
                isValid = false;
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            // Прокрутка к первой ошибке
            const firstError = form.querySelector('.error-message[style*="block"]');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    // Предотвращение выбора больше максимального количества
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const questionId = this.dataset.questionId;
            const questionBlock = form.querySelector(`.question-block[data-question-id="${questionId}"]`);
            if (!questionBlock) return;
            
            const max = parseInt(questionBlock.dataset.questionMax);
            const checkboxesInQuestion = Array.from(form.querySelectorAll(`input[type="checkbox"][data-question-id="${questionId}"]`));
            const checkedCount = checkboxesInQuestion.filter(cb => cb.checked).length;
            
            if (checkedCount >= max) {
                // Отключаем невыбранные чекбоксы
                checkboxesInQuestion.forEach(cb => {
                    if (!cb.checked) {
                        cb.disabled = true;
                    }
                });
            } else {
                // Включаем все чекбоксы
                checkboxesInQuestion.forEach(cb => {
                    cb.disabled = false;
                });
            }
        });
    });
})();
</script>

<style>
.form-check-group {
    padding-left: 1.5rem;
}

.form-check {
    display: flex;
    align-items: center;
    border-radius: 0.375rem;
    transition: background-color 0.15s ease;
    cursor: pointer;
}

.form-check:hover {
    background-color: #f8f9fa;
}

.form-check-input {
    width: 1.75rem;
    height: 1.75rem;
    min-width: 1.75rem;
    min-height: 1.75rem;
    margin-top: 0;
    margin-bottom: 0;
    cursor: pointer;
    border: 2px solid #000 !important;
    border-radius: 0.25rem;
    flex-shrink: 0;
}

.form-check-input[type="radio"] {
    border-radius: 50%;
}

.form-check-input:checked {
    border-color: #000 !important;
    background-color: #0d6efd;
}

.form-check-input:focus {
    border-color: #000 !important;
    box-shadow: 0 0 0 0.25rem rgba(0, 0, 0, 0.25);
}

.form-check-label {
    font-size: 1.1rem;
    line-height: 1.5;
    cursor: pointer;
    padding: 0.75rem;
    padding-left: 0.5rem;
    display: block;
    width: 100%;
    border-radius: 0.375rem;
}

.error-message {
    font-weight: 500;
}
</style>
{% endblock %}

